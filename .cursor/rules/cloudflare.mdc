---
description: Cloudflare Pages configuration and deployment documentation for pickyouragent.dev
alwaysApply: false
---
# Cloudflare Pages Configuration

## Overview

This project is deployed to Cloudflare Pages with a custom domain. The configuration ensures optimal caching behavior: Cloudflare edge servers cache all content, while browsers cache static assets but always fetch fresh HTML.

## Cloudflare Configuration

### Project Details
- **Project ID**: `pickyouragent-dev`
- **Production URL**: `pickyouragent-dev.pages.dev`
- **Custom Domain**: `pickyouragent.dev`
- **Deployment**: Automated via GitHub Actions workflow

### Deployment Workflow

Deployment is handled by `.github/workflows/deploy.yml`:
1. Builds the Astro project using pnpm
2. Uploads build artifacts
3. Deploys to Cloudflare Pages using `wrangler-action@v3`
4. Deploys from the `dist` directory to the `pickyouragent-dev` project
5. Purges Cloudflare cache to ensure fresh content is served immediately

### Caching Strategy

The caching strategy is implemented using a **Cloudflare Pages Function** middleware (`public/functions/_middleware.ts`). This approach provides programmatic control over caching and ensures Cloudflare actually caches HTML files (which doesn't happen by default with just `_headers`).

The middleware:
- Intercepts all requests before they're served
- Uses Cloudflare's Cache API to explicitly cache responses
- Sets appropriate `Cache-Control` headers based on content type
- Adds `CDN-Cache-Control` header to force Cloudflare edge caching

#### HTML Files
- **Cloudflare Edge Cache**: 1 year (via Cache API + `CDN-Cache-Control`)
- **Browser Cache**: No caching (`max-age=0, must-revalidate`)
- **Result**: Browsers always fetch fresh HTML, while Cloudflare serves cached versions for performance
- **Cache Status**: `cf-cache-status: HIT` (after first request)

#### Static Assets (CSS, JS, images, etc.)
- **Cloudflare Edge Cache**: 1 year (via Cache API + `CDN-Cache-Control`)
- **Browser Cache**: 1 year (`max-age=31536000, immutable`)
- **Result**: Both Cloudflare and browsers cache static assets for maximum performance
- **Cache Status**: `cf-cache-status: HIT` (after first request)

### Cache-Control Headers

The middleware sets headers dynamically:

**HTML Files**:
```
Cache-Control: public, s-maxage=31536000, max-age=0, must-revalidate
CDN-Cache-Control: public, max-age=31536000
```

**Static Assets**:
```
Cache-Control: public, s-maxage=31536000, max-age=31536000, immutable
CDN-Cache-Control: public, max-age=31536000
```

**Key Directives**:
- `public`: Allows caching by shared caches (Cloudflare edge) and browsers
- `s-maxage=31536000`: Cloudflare edge cache duration (1 year in seconds)
- `max-age=0`: For HTML - browsers must revalidate (no cache)
- `max-age=31536000`: For assets - browsers cache for 1 year
- `immutable`: For assets - indicates content never changes
- `must-revalidate`: For HTML - browsers must check with server before using cached content
- `CDN-Cache-Control`: Cloudflare-specific header that takes precedence over `Cache-Control` for edge caching

### Cache Purging

After each deployment, the workflow automatically purges the Cloudflare cache for the custom domain. This ensures that users immediately receive fresh content after deployment, even though Cloudflare edge servers cache content for performance.

The cache purge step:
- Runs immediately after successful deployment
- Uses the Cloudflare API to purge all cached content for the zone
- Requires `CLOUDFLARE_ZONE_ID` secret (zone ID for `pickyouragent.dev`)

### How It Works

1. **Build Process**: 
   - Astro builds static HTML files to `dist/`
   - Astro copies `public/functions/` to `dist/functions/` (Pages Functions)
2. **Deployment**: GitHub Actions deploys `dist/` to Cloudflare Pages
3. **Cache Purge**: Cloudflare cache is purged to ensure fresh content
4. **Request Handling**:
   - **First Request**: Middleware intercepts, checks cache (miss), fetches from origin, sets headers, stores in cache
   - **Subsequent Requests**: Middleware intercepts, finds cached response, returns immediately
   - HTML requests: Cloudflare serves from cache (`cf-cache-status: HIT`), browsers always fetch fresh
   - Asset requests: Both Cloudflare and browsers serve from cache (`cf-cache-status: HIT`)

### Pages Functions Middleware

The middleware (`public/functions/_middleware.ts`) uses Cloudflare's Cache API to explicitly cache responses:

1. **Cache Check**: Uses `caches.default.match()` to check if response is cached
2. **Cache Miss**: Fetches from origin via `context.next()`, modifies headers, stores in cache
3. **Cache Hit**: Returns cached response immediately
4. **Header Setting**: Sets both `Cache-Control` (for browsers) and `CDN-Cache-Control` (for Cloudflare edge)

**Why Pages Functions?**
- Cloudflare Pages doesn't cache HTML by default, even with `_headers` file
- The `_headers` file only sets headers but doesn't force edge caching
- Pages Functions middleware gives full programmatic control over caching behavior
- Using the Cache API explicitly tells Cloudflare to cache everything, including HTML

### Benefits

- ✅ **Fast Edge Delivery**: Cloudflare caches all content at edge locations worldwide
- ✅ **Fresh HTML**: Users always get the latest HTML content
- ✅ **Efficient Asset Delivery**: Static assets are cached by browsers, reducing bandwidth
- ✅ **Immediate Updates**: HTML changes are visible immediately to users
- ✅ **Automatic Cache Invalidation**: Cache is automatically purged after each deployment

### Required GitHub Secrets

The deployment workflow requires the following secrets:
- `CLOUDFLARE_API_TOKEN`: API token with Pages deployment and cache purge permissions
- `CLOUDFLARE_ACCOUNT_ID`: Cloudflare account ID
- `CLOUDFLARE_ZONE_ID`: Zone ID for the custom domain (`pickyouragent.dev`)

**Note**: The zone ID can be found in the Cloudflare dashboard under the domain's overview page.

### API Token Permissions

The `CLOUDFLARE_API_TOKEN` must have the following permissions:

#### For Pages Deployment:
- **Account** → **Cloudflare Pages** → **Edit** (or **Read** if using read-only token)
- **Account** → **Account** → **Read** (to access account information)

#### For Cache Purging:
- **Zone** → **Cache Purge** → **Purge** (required to purge cached content)
- **Zone** → **Zone** → **Read** (required to access zone details)

#### Zone Resources:
- **Include** → **Specific Zone** → `pickyouragent.dev` (or use account-level permissions)

**To configure the token:**
1. Navigate to [Cloudflare API Tokens](https://dash.cloudflare.com/profile/api-tokens)
2. Create a custom token or edit an existing one
3. Add all required permissions listed above
4. Set zone resources to include `pickyouragent.dev`
5. Save the token and add it to GitHub secrets as `CLOUDFLARE_API_TOKEN`

### Verification

After deployment, verify caching is working:

```bash
# First request (should be MISS or EXPIRED)
curl -I https://pickyouragent.dev/

# Second request (should be HIT)
curl -I https://pickyouragent.dev/

# Check asset file headers
curl -I https://pickyouragent.dev/_astro/global.css
```

**Expected Results**:

**First Request**:
- `cf-cache-status: MISS` or `EXPIRED`
- `Cache-Control: public, s-maxage=31536000, max-age=0, must-revalidate` (for HTML)
- `CDN-Cache-Control: public, max-age=31536000`

**Subsequent Requests**:
- `cf-cache-status: HIT` ✅ (This confirms caching is working!)
- Same `Cache-Control` headers as above

**For Assets**:
- `cf-cache-status: HIT` (after first request)
- `Cache-Control: public, s-maxage=31536000, max-age=31536000, immutable`
- `CDN-Cache-Control: public, max-age=31536000`

**Troubleshooting**:
- If you see `cf-cache-status: DYNAMIC`, the middleware isn't working - check that `dist/functions/_middleware.ts` exists after build
- If you see duplicate `Cache-Control` headers, there may be conflicting `_headers` file (should be removed)

### File Structure

```
public/
└── functions/
    └── _middleware.ts    # Pages Function middleware for caching

dist/  (after build)
├── functions/
│   └── _middleware.ts    # Automatically copied by Astro
├── index.html
└── ...
```

**Important**: The `functions` directory must be in `public/` so Astro copies it to `dist/` during build. Cloudflare Pages looks for `functions/` in the root of the deployed directory.

### Notes

- **Pages Functions Location**: Must be in `public/functions/` (not project root) so Astro copies it to `dist/functions/` during build
- **Middleware Execution**: The middleware runs on every request before serving content
- **Cache API**: Uses Cloudflare's `caches.default` API to explicitly store and retrieve cached responses
- **CDN-Cache-Control**: This header takes precedence over `Cache-Control` for Cloudflare edge caching
- **Deployment**: Changes to the middleware require a new deployment to take effect
- **No `_headers` File**: The `_headers` file is not needed (and was removed) since the middleware handles all caching logic
